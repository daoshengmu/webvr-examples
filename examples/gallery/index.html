<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  </head>
  <body></body>
</html>
<style>
html, body {
  width: 100%;
  height: 100%;
  background-color: #000;
  color: #fff;
  margin: 0px;
  padding: 0;
  overflow: hidden;
}

canvas {
  position: absolute;
  top: 0;
}
</style>
<script>
WebVRConfig = {
  MOUSE_KEYBOARD_CONTROLS_DISABLED: false,
  BUFFER_SCALE: 1.0,
};

document.addEventListener('touchmove', function(e) {
  e.preventDefault();
});
</script>
<script src="../../node_modules/three/build/three.js"></script>
<script src="../../node_modules/three/examples/js/effects/VREffect.js"></script>
<script src="../../node_modules/three/examples/js/controls/VRControls.js"></script>
<script src="../../node_modules/webvr-polyfill/build/webvr-polyfill.min.js"></script>
<script src="../../node_modules/webvr-ui/build/webvr-ui.min.js"></script>
<!-- Need to remove e.preventDefault(); at onTouchStart_ and onTouchEnd_ in ray.js
Otherwise, Enter VR button will not work on mobile. -->
<script src="../../node_modules/ray-input/build/ray.js"></script>
<script>
    var camera, scene, renderer;
    var texture_placeholder,
    materials = [],
    vrControls, vrEffect, vrDisplay, enterVR,
    mainSphere, tb1Mesh, tb2Mesh, tb3Mesh,
    rayInput,
    isUserInteracting = false,
    onMouseDownMouseX = 0, onMouseDownMouseY = 0,
    lon = 0, onMouseDownLon = 0,
    lat = 0, onMouseDownLat = 0,
    phi = 0, theta = 0,
    distance = 500,
    onPointerDownPointerX = 0,
    onPointerDownPointerY = 0,
    onPointerDownLon = 0,
    onPointerDownLat = 0;

    const DEFAULT_COLOR = new THREE.Color(0xFFFFFF);
    const HIGHLIGHT_COLOR = new THREE.Color(0x1E90FF);
    const ACTIVE_COLOR = new THREE.Color(0xFF3333);

    init();
    animate();
    function init() {
        var mesh;
        camera = new THREE.PerspectiveCamera(75, window.innerWidth /
                                             window.innerHeight, 0.1, 10000 );
        scene = new THREE.Scene();
    
        // Setup three.js WebGL renderer.
        // Note: Antialiasing-enabled on mobile
        // will make renderer creation failed.
        renderer = new THREE.WebGLRenderer({antialias: false});
        renderer.setPixelRatio(Math.floor(window.devicePixelRatio));
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0xffffff);
        document.body.appendChild(renderer.domElement);
        
        window.addEventListener('resize', onWindowResize);

        materials.push(new THREE.MeshBasicMaterial({
            map: new THREE.TextureLoader().load( 'resource/puydesancy.jpg' )
        }));
        materials.push(new THREE.MeshBasicMaterial({
            map: new THREE.TextureLoader().load( 'resource/2294472375_24a3b8ef46_o.jpg' )
        }));
        materials.push(new THREE.MeshBasicMaterial({
            map: new THREE.TextureLoader().load( 'resource/lake.jpg' )
        }));

        // Thumbnails
        let tb1 = new THREE.SphereGeometry(0.5, 60, 40);
        tb1Mesh = new THREE.Mesh(tb1, materials[0]);
        tb1Mesh.position.set(-1, -1, -3);
        scene.add(tb1Mesh);

        let tb2 = new THREE.SphereGeometry(0.5, 60, 40);
        tb2Mesh = new THREE.Mesh(tb2, materials[1]);
        tb2Mesh.position.set(0, -1, -3);
        scene.add(tb2Mesh);

        let tb3 = new THREE.SphereGeometry(0.5, 60, 40);
        tb3Mesh = new THREE.Mesh(tb3, materials[2]);
        tb3Mesh.position.set(1, -1, -3);
        scene.add(tb3Mesh);

        // Show paranoma in WebGL
        let geometry = new THREE.SphereGeometry(500, 60, 40);
        geometry.scale(-1, 1, 1);

        mainSphere = new THREE.Mesh(geometry, materials[0].clone());
        scene.add(mainSphere);

        // Initialize VR
        // Apply VR headset positional data to camera.
        vrControls = new THREE.VRControls(camera);
        vrEffect = new THREE.VREffect(renderer);
        vrEffect.setSize(window.innerWidth, window.innerHeight);
        var options = {}
        enterVR = new webvrui.EnterVRButton(renderer.domElement, options);
        document.body.appendChild(enterVR.domElement);

        enterVR.getVRDisplay().then((displays)=>{
            if (displays.length > 0) {
                vrDisplay = displays[0];
            }
            createRayInput();
        }).catch(() => {
            // no vr display
            createRayInput();
        });
    }

    function createRayInput() {
        rayInput = new RayInput.default(camera, renderer.domElement);
        rayInput.setSize(renderer.getSize());
        scene.add(rayInput.getMesh());

        // Register a callback whenever an object is acted on.
        rayInput.on('raydown', (opt_mesh) => {
          // Called when an object was activated.
          // If there is a selected object, opt_mesh is that object.
          if (opt_mesh) {
            console.log('raydown...');
            mainSphere.material = opt_mesh.material.clone();
            mainSphere.material.color = DEFAULT_COLOR;
          }
        });

        // Register a callback when an object is selected.
        rayInput.on('rayover', (mesh) => {
          // Called when an object was selected.
          console.log('rayover...');
          mesh.material.color = HIGHLIGHT_COLOR;
        });

        // Register a callback when an object is selected.
        rayInput.on('rayout', (mesh) => {
          // Called when an object was unselected.
          console.log('rayover...');
          mesh.material.color = DEFAULT_COLOR;
        });

        rayInput.add(tb1Mesh);
        rayInput.add(tb2Mesh);
        rayInput.add(tb3Mesh);       
    }

    function onWindowResize() {
        vrEffect.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        if (rayInput) {
            rayInput.setSize(renderer.getSize());
        }
    }

    function onVRDisplayPresentChange() {
        console.log('onVRDisplayPresentChange');
        onWindowResize();
    }

    function animate() {
        // Update the input system in a game loop.
        if (rayInput) {
            rayInput.update();
        }

        vrControls.update();

        if (enterVR.isPresenting()) {
            vrEffect.render(scene, camera);
        } else {
            renderer.render(scene, camera);
        }

        if (vrDisplay) {
            vrDisplay.requestAnimationFrame(animate);
        } else {
            window.requestAnimationFrame(animate);
        }
    }
</script>